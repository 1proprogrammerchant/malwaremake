/*
  Âñïîìîãàòåëüíûå ôóíêöèè äëÿ êîíñîëüíîãî èíòåðôåéñà.
*/
#pragma once

namespace Cui
{
  //Exit codes for ExitProcess. By default, the exit code is EXITCODE_BAD_COMMAND_LINE!
  enum
  {
    EXITCODE_SUCCESSED,                  //No errors.
    EXITCODE_ERROR_BAD_COMMAND_LINE,     //Error in command line syntax.
    EXITCODE_ERROR_FILE_NOT_FOUND,       //File not found.
    EXITCODE_ERROR_NOT_ENOUGH_MEMORY,    //Not enough memory.
    EXITCODE_ERROR_CONFIG_FORMAT,        //Error in the syntax of the configuration file.
    EXITCODE_ERROR_INPUT_FILE_CORRUPTED, //The source file is corrupted.
    EXITCODE_ERROR_SOCKET,               //Error when working with sockets.
    EXITCODE_ERROR_WRITE_OUTPUT_FILE,    //Error while writing destination file.
    EXITCODE_ERROR_CREATE_DIR,           //Failed to create directory.
    EXITCODE_ERROR_UNKNOWN               //Unknown error.
  };

  /*
    Ôóíêöèÿ äëÿ äàëüíåéøåé îáðàáîòêè êîìàíäíîé ñòðîêè, äîëæíû ïðåäñòàâëÿòü èç ñåáÿ
    Cmd[Cmdname]::Call(...). Ôóíêöèÿ äîëæíà ñàìîñòîÿòåëüíî âûñòàâëÿòü coreData.exitCode, è
    âûçûâàòü Core::showHelp() â ñëó÷àè ñîîòâåòñòâåííîé îøèáêè. Íóæíî ó÷èòûâàòü, ÷òî ñèíòàêñèñ
    âñåõ îïöèè óæå ïðîâåðåí, ò.å. íàïðèìåð åñëè îïöèÿ ñîäåðæèò êàêîé-òî ïàðàìåòð, òî ïðè âûçîâå
    ýòîé ôóíêöèè îí ïðîâåðåíî ñóùåñòâóåò.

    IN switches      - îïöèè ïåðåäàâàåìûå èç êîìàíäíîé ñòðîêè. Ïðè ïîèñêè íóæíîé îïöèè âíóòðè
                       ôóíêöèè, ïîèñê äîëæåí ïðîèçâîäèòüñÿ ñ ó÷åòîì ðåãèñòðà.
    IN switchesCount - êîëè÷åñòâî îïöèè.
  */
  typedef void (* COMMANDCALLBACK)(LPWSTR *switches, DWORD switchesCount);

  //Structure to work with teams
  typedef struct
  {
    LPWSTR name;         //The name of the option.
    LPWSTR description;  //Description of the option.
  }SWITCH;

  typedef struct
  {
    LPWSTR name;              //The name of the team.
    LPWSTR description;       //Description of the team.
    COMMANDCALLBACK callback; //Function associating with the team.
    SWITCH *switches;         //Command options.
    BYTE switchesCount;       //Count. options.
  }COMMAND;

  /*
    Èíèöèàëèçàöèÿ.
  */
  void init(void);

  /*
    Äåèíèöèàëèçàöèÿ.
  */
  void uninit(void);

  /*
    Ïîëó÷åíèå òåêóùåé êîìàíäû èç êîìàíäíîé ñòðîêè.
    
    IN args          - ìàññèâ àðãóìåíòîâ êîìàíäíîé ñòðîêè.
    IN argsCount     - êîëè÷åñòâî ýëåìåíòîâ â args.
    IN commands      - ìàññèâ ïîääåðæèâàåìûõ êîìàíä.
    IN commandsCount - êîëè÷åñòâî ýëåìåíòîâ â commands.

    Return           - óêàçàòåëü íà ýëåìåíò èç ìàññèâà commands, èëè NULL åñëè êîìàíäà íå íàéäåíà.
  */
  COMMAND *_getCommand(const LPWSTR *args, int argsCount, const COMMAND *commands, BYTE commandsCount);

  /*
    Ïðîâåðêà îïöèé êîìàíäíîé ñòðîêè.

    IN args          - ìàññèâ àðãóìåíòîâ êîìàíäíîé ñòðîêè.
    IN argsCount     - êîëè÷åñòâî ýëåìåíòîâ â args.
    IN switches      - ìàññèâ ïîääåðæèâàåìûõ îïöèé.
    IN switchesCount - êîëè÷åñòâî ýëåìåíòîâ â switches.

    Return           - 0 - îøèáîê íå íàéäåíî,
                       MAKELONG(1, i) - ñèíòàêñè÷åñêàÿ îøèáêà, ãäå i èíäåêñ ýëåìåíòà â args,
                       MAKELONG(2, i) - íåèçâåñòíàÿ îïöèÿ, ãäå i èíäåêñ ýëåìåíòà â args.
  */
  DWORD _checkSwitches(const LPWSTR *args, int argsCount, const SWITCH *switches, BYTE switchesCount);

  /*
    Ïîëó÷åíèå çíà÷åíèÿ îïöèè.

    IN switches       - ìàññèâ îïöèé.
    IN switchesCount  - êîëè÷åñòâî ýëåìåíòîâ â pstrList.
    IN requeredSwitch - îïöèÿ, êîòîðóþ íóæíî íàéòè.

    Return            - åñëè çíà÷åíèå ñóùåñòâóåò - óêàçàòåëü íà çíà÷åíèå îïöèè,
                        åñëè çíà÷åíèå îòñóòâóåò  - (LPWSTR)1,
                        åñëè îïöèÿ îòñóòâóåò     - NULL.

    Âíèìàíèå: Ïîñëå ðàáîòû ýòîé ôóíêöèè àðãóìåíò ìîæåò îòëè÷àòüñÿ îò îðèãèíàëüíîãî, èç-çà óäàëåíèÿ
              êàâû÷åê â ñëó÷àè èõ íàëè÷èÿ.
  */
  LPWSTR _getSwitchValue(const LPWSTR *switches, DWORD switchesCount, const LPWSTR requeredSwitch);

  /*
    Îòîáðàæåíèå ïîìîøè.

    IN commands      - ñïèñîê êîìàíä.
    IN commandsCount - êîëè÷åòñâî êîìàíä.
    IN switches      - ñïèñîê îïöèè.
    IN switchesCount - êîëè÷åñòâî îïöèé.
    IN mainTitle     - øàáëîí çàãîëîâêà, íàïðèìåð
                       "usage: %s <command> -<switch 1> -<switch N>\n\n<Commands>\n"
    IN fileName      - èìÿ ôàéëà äëÿ ïðèìåðà â mainTitle.
    IN switchesTitle - çàãîëîâîå äëÿ îïöèé.
  */
  void _showHelp(const COMMAND *commands, BYTE commandsCount, const LPWSTR mainTitle, const LPWSTR fileName);
};

/*Â Â Standard obrabodchik command line.*/
#define CUI_DEFAULT_COMMANDLINE_HELPER \
{\
  Cui::COMMAND *currentCommand;\
  DWORD switchesResult;\
  if(coreData.commandLine.argsCount < 2)\
  {\
    Core::showLogo();\
    Cui::_showHelp(commands, sizeof(commands) / sizeof(Cui::COMMAND), lng_help_title, CWA(shlwapi, PathFindFileNameW)(coreData.fileName));\
  }\
  else if((currentCommand = Cui::_getCommand(coreData.commandLine.args, coreData.commandLine.argsCount, commands, sizeof(commands) / sizeof(Cui::COMMAND))) == NULL)\
  {\
    Core::showLogo();\
    Console::writeFormatW(lng_error_uknown_command, coreData.commandLine.args[1]);\
  }\
  else if((switchesResult = Cui::_checkSwitches(coreData.commandLine.args, coreData.commandLine.argsCount, currentCommand->switches, currentCommand->switchesCount)) != 0)\
  {\
    Core::showLogo();\
    WORD index = HIWORD(switchesResult);\
    if(LOWORD(switchesResult) == 1)Console::writeFormatW(lng_error_syntax_error, coreData.commandLine.args[index]);\
    else Console::writeFormatW(lng_error_uknown_switch, coreData.commandLine.args[index]);\
  }\
  else\
  {\
    if(Cui::_getSwitchValue(coreData.commandLine.args + 2, coreData.commandLine.argsCount - 2, lng_switch_nologo) != (LPWSTR)1)Core::showLogo();\
    currentCommand->callback(coreData.commandLine.args + 2, coreData.commandLine.argsCount - 2);\
  }\
}
